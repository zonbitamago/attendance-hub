# Feature Specification: 複数イベント一括出欠登録

**Feature Branch**: `004-bulk-attendance-register`
**Created**: 2025-11-08
**Status**: Draft
**Input**: User description: "メンバーが自分の出欠を複数イベント分一括で登録・更新できる機能"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 複数イベントへの一括出欠登録 (Priority: P1)

メンバーは自分の所属グループと名前を1回選択するだけで、複数のイベントに対して出欠状況を一度に登録できる。現在はイベントごとに個別の登録画面へ遷移し、毎回グループと名前を選択する必要があるが、この機能により登録作業が大幅に効率化される。

**Why this priority**: これは本機能の核心的価値。月4回の練習×10名のメンバーなら40回の操作が必要だったものを、1画面で完結できる。ユーザーの最大のペインポイントを解決する。

**Independent Test**: 新規ページ `/my-register` にアクセスし、グループと名前を選択後、複数のイベントにチェックを入れてステータスを設定し、一括登録ボタンを押すことで、選択したすべてのイベントに出欠が登録されることを確認できる。

**Acceptance Scenarios**:

1. **Given** メンバーが `/my-register` ページにアクセスし、**When** グループ「トランペット」と名前「田中太郎」を選択し、3つのイベント（1/15, 1/22, 1/29）にチェックを入れ、それぞれ「◯」「△」「✗」のステータスを設定して「一括登録」ボタンを押す、**Then** 3つのイベントすべてに田中太郎の出欠が登録され、確認メッセージ「3件登録しました」が表示される
2. **Given** メンバーがグループと名前を選択済みで、**When** イベント一覧を表示する、**Then** 既に出欠登録済みのイベントには現在のステータス（◯/△/✗）が表示される
3. **Given** メンバーが5つのイベントを選択して一括登録を試みた際、**When** そのうち2つは既に登録済みの場合、**Then** 既存の2件は更新され、新規の3件は作成され、「5件登録（うち2件更新）」のメッセージが表示される

---

### User Story 2 - 既存出欠の自動更新（重複防止） (Priority: P2)

既に出欠登録済みのイベントを再度選択して登録した場合、重複レコードを作成せず、自動的に既存の出欠ステータスを更新する。これにより、データの整合性を保ち、集計時の誤カウントを防ぐ。

**Why this priority**: 現在のシステムには重複登録バグが存在し、同じメンバーが同じイベントに複数の出欠レコードを作成できてしまう。これはデータの信頼性を損なう重大な問題であり、一括登録機能と同時に修正すべき。

**Independent Test**: 既に出欠登録済みのイベントに対して、異なるステータスで再登録を試みる。データを確認し、重複レコードが作成されず、既存レコードが更新されていることを検証できる。

**Acceptance Scenarios**:

1. **Given** 田中太郎が1/15のイベントに「◯（出席）」で既に登録済み、**When** 同じ田中太郎が同じイベントを選択して「✗（欠席）」に変更して登録する、**Then** 新しいレコードは作成されず、既存のレコードのステータスが「✗」に更新される
2. **Given** あるメンバーが複数イベントに登録済み、**When** そのうち一部のイベントのステータスを変更して一括登録する、**Then** 変更したイベントのみが更新され、変更していないイベントは元のステータスのまま保持される
3. **Given** システムに同一メンバー×同一イベントの重複レコードが存在する（バグにより作成済み）、**When** そのイベントを含む一括登録を実行する、**Then** 重複レコードのうち最新のもの1つだけが保持され、古いレコードは削除される

---

### User Story 3 - イベントごとの個別ステータス設定 (Priority: P3)

複数のイベントに一括登録する際、各イベントごとに異なるステータス（◯/△/✗）を個別に設定できる。例えば「1/15は出席、1/22は未定、1/29は欠席」といった柔軟な登録が可能。

**Why this priority**: ユーザーからのフィードバック（Q2-B）により、すべて同じステータスではなく、イベントごとに異なるステータスを設定したいニーズが明確化された。P1の基本機能に加えて、この柔軟性が実用性を高める。

**Independent Test**: 一括登録画面で3つのイベントを選択し、1つ目を「◯」、2つ目を「△」、3つ目を「✗」に設定して登録。各イベントの詳細ページで正しいステータスが登録されていることを確認できる。

**Acceptance Scenarios**:

1. **Given** メンバーが4つのイベントを選択、**When** 各イベントに対して異なるステータス（◯、◯、△、✗）を個別設定して登録する、**Then** それぞれのイベントに設定したステータスが正しく保存される
2. **Given** メンバーが10個のイベントを選択、**When** まず全イベントを「◯」に一括設定し、その後2つのイベントだけ「✗」に個別変更して登録する、**Then** 2つは「✗」、残り8つは「◯」で登録される
3. **Given** イベント一覧に既存登録済みのイベントが混在、**When** 新規イベントと既存イベントを含めて選択し個別ステータスを設定する、**Then** 新規イベントは作成、既存イベントは更新され、すべて指定したステータスになる

---

### Edge Cases

- **イベント選択なしで登録**: メンバーがグループと名前を選択したが、イベントを1つも選択せずに「一括登録」ボタンを押した場合、エラーメッセージ「登録するイベントを選択してください」を表示し、登録を実行しない
- **グループ/名前未選択**: イベントを選択したがグループまたは名前を選択していない場合、該当フィールドにエラー表示「グループを選択してください」「名前を入力してください」を表示し、登録を実行しない
- **新規メンバー作成時の重複**: 新規メンバー名を入力した際、既に同じグループ内に同じ名前のメンバーが存在する場合、確認メッセージ「このメンバーは既に存在します。既存のメンバーを選択しますか？」を表示し、ユーザーに選択を促す
- **大量イベント選択**: ユーザーが50個以上のイベントを一度に選択した場合でも、システムは正常に動作する（パフォーマンステスト必要）
- **セッション途中の離脱**: ユーザーがグループ・名前を選択し、イベントを選択中にブラウザを閉じた場合、次回アクセス時は最初から（グループ選択から）やり直す
- **localStorageの容量制限**: 大量の出欠データが蓄積され、localStorageの容量制限に近づいた場合、警告メッセージを表示する（将来的なデータベース移行の準備）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは新規ページ `/my-register` を提供し、メンバーが複数イベントの出欠を一括登録できる画面を表示しなければならない
- **FR-002**: システムはグループと名前の選択を1回のみ要求し、セッション中はその情報を保持しなければならない（localStorageへの永続化は行わない）
- **FR-003**: システムは近日開催予定のイベント一覧を表示し、各イベントにチェックボックスで選択可能にしなければならない
- **FR-004**: システムは各イベントごとに◯（出席）、△（未定）、✗（欠席）の3つのステータスを個別に設定できるUIを提供しなければならない
- **FR-005**: システムは選択したメンバーが既に登録済みのイベントについて、現在のステータスを表示しなければならない
- **FR-006**: システムは一括登録実行時に、同一メンバー×同一イベントの重複レコードを作成せず、既存レコードを更新（upsert）しなければならない
- **FR-007**: システムは一括登録の結果として、「N件登録（うちM件更新）」といった詳細なフィードバックメッセージを表示しなければならない
- **FR-008**: システムは新規メンバー名の入力時、同一グループ内での重複チェックを行い、既存メンバーがいる場合は警告を表示しなければならない
- **FR-009**: システムはイベント未選択またはグループ/名前未選択の状態での登録試行を防止し、適切なバリデーションエラーを表示しなければならない
- **FR-010**: システムは一括登録処理中にエラーが発生した場合、部分的な成功を許容し（一部のイベントは登録成功）、失敗した項目と理由を明示しなければならない
- **FR-011**: システムはトップページまたは管理画面から `/my-register` へのナビゲーションリンクを提供しなければならない
- **FR-012**: システムは既存の個別登録機能（`/events/[id]/register`）を維持し、新機能と並行して使用可能でなければならない

### Key Entities *(include if feature involves data)*

- **Attendance（出欠レコード）**: イベント日程とメンバーを紐付け、ステータス（◯/△/✗）を保持する。一括登録機能では、複数のAttendanceレコードを一度のトランザクションで作成または更新する
  - 重要な制約: `eventDateId + memberId` の組み合わせは一意でなければならない（重複防止）
  - 更新時は既存レコードのIDを保持し、ステータスのみを更新する

- **Member（メンバー）**: グループに所属する個人。一括登録時に新規メンバーを作成する場合、同一グループ内での名前の重複チェックが必要
  - 関連: 1つのMemberは複数のAttendanceを持つ

- **EventDate（イベント日程）**: 出欠登録の対象となるイベント。一括登録画面では複数のEventDateを選択可能にする

- **BulkRegistrationSession（セッション情報）**: ページ内で保持するメンバー識別情報（groupId, memberId または新規メンバー名）
  - 永続化しない（Reactのstateまたはコンポーネント内変数）
  - ページリロードやブラウザ終了でクリアされる

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: メンバーは1つの画面で複数イベント（最大50件）の出欠を登録でき、グループと名前の入力は1回のみで完了する
- **SC-002**: 既存の出欠レコードを持つイベントへの再登録時、重複レコードが作成されず、常に1メンバー×1イベント=1レコードの状態を維持する
- **SC-003**: 10個のイベントに一括登録する場合、従来の個別登録（10回の画面遷移と入力）に比べて、操作時間が70%以上削減される
- **SC-004**: 一括登録処理は5秒以内に完了し、ユーザーに成功/失敗の明確なフィードバックが提供される
- **SC-005**: システム全体で同一メンバー×同一イベントの重複出欠レコードが存在しない状態を保証する（既存の重複も一括登録時に解消）
- **SC-006**: ユーザーはイベントごとに異なるステータスを設定でき、90%以上のユーザーが1回の試行で意図したステータスを正しく登録できる

# CI/CD クイックスタート

**機能**: CI/CDパイプライン設定
**ブランチ**: `006-ci-cd-setup`
**作成日**: 2025-11-09

## 概要

このプロジェクトでは、GitHub Actionsを使用したCI/CDパイプラインが設定されています。プルリクエスト作成時に自動的にコード品質チェックが実行されます。

## 自動実行されるチェック

すべてのプルリクエストで以下が自動実行されます：

1. **型チェック**: TypeScript strict mode
2. **リント**: ESLint
3. **テスト**: Jest（カバレッジ測定付き）
4. **ビルド検証**: Next.js build

## ローカルでのCI同等チェック実行

プルリクエスト作成前に、ローカルでCIと同じチェックを実行できます：

```bash
# 1. 型チェック
npx tsc --noEmit

# 2. リント
npm run lint

# 3. テスト（カバレッジ付き）
npm test -- --coverage

# 4. ビルド検証
npm run build
```

## カバレッジ要件

- **最小閾値**: 80%
- **対象メトリクス**: branches, functions, lines, statements
- **閾値未達時**: CIビルドが失敗し、PRマージ不可

## CI失敗時の対応手順

### 1. エラー詳細の確認

1. GitHubのPRページで「Checks」タブを開く
2. 失敗したジョブをクリック
3. エラーログを確認

### 2. ローカルで再現

```bash
# エラーが発生したコマンドをローカルで実行
# 例: テスト失敗の場合
npm test

# 例: リントエラーの場合
npm run lint
```

### 3. 修正と再実行

1. エラーを修正
2. 再度コミット＆プッシュ
3. CIが自動的に再実行される

## GitHub Actions ワークフローファイル

**パス**: `.github/workflows/ci.yml`

このファイルがCI/CDパイプラインの設定を定義しています。

## テスト環境

- **OS**: Ubuntu latest
- **Node.js**: 20.x, 22.x（マトリックステスト）
- **パッケージマネージャー**: npm

## よくある質問

### Q: CIの実行時間はどのくらいですか？

A: 通常のPRで3〜5分程度です。キャッシュが効いている場合はより高速です。

### Q: カバレッジ80%を達成できません

A: 段階的に改善してください。まずは以下を確認：

1. テストされていないファイルを`jest.config.mjs`の`collectCoverageFrom`から除外
2. エッジケースのテストを追加
3. 必要に応じて閾値を一時的に引き下げ（60% → 70% → 80%）

### Q: 特定のブランチでCI

をスキップしたい

A: 現在の設定では、`main`と`develop`へのPRおよびpushでのみCIが実行されます。他のブランチではスキップされます。

## 関連ドキュメント

- [実装計画](plan.md) - 技術的な設計詳細
- [機能仕様書](spec.md) - 機能要件と成功基準
- [プロジェクトガイドライン](../../CLAUDE.md) - CI/CD運用ガイドライン

## トラブルシューティング

### エラー: "Coverage for X is below threshold"

**原因**: テストカバレッジが80%未満

**解決方法**:

1. カバレッジレポートを確認: `npm test -- --coverage`
2. カバレッジが低いファイルを特定
3. 該当ファイルのテストを追加

### エラー: "npm ci failed"

**原因**: 依存関係のインストール失敗

**解決方法**:

1. `package-lock.json`が最新か確認
2. ローカルで`npm ci`を実行して再現
3. 必要に応じて`npm install`で依存関係を更新

### エラー: "Linting errors found"

**原因**: ESLintエラー

**解決方法**:

1. `npm run lint`でエラーを確認
2. 自動修正: `npm run lint -- --fix`
3. 手動修正が必要な場合は該当箇所を修正

## セットアップ不要

CI/CDパイプラインは既に設定済みです。開発者は通常通りPRを作成するだけで、自動的にチェックが実行されます。

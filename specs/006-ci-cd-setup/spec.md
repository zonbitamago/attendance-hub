# Feature Specification: CI/CDパイプライン設定

**Feature Branch**: `006-ci-cd-setup`
**Created**: 2025-11-09
**Status**: Draft
**Input**: User description: "GitHub Actionsを使用した自動テスト、リント、ビルド検証、テストカバレッジ監視のためのCI/CDパイプライン設定"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - プルリクエスト時の自動品質チェック (Priority: P1)

開発者として、すべてのコード品質チェック（テスト、リント、型チェック、ビルド）がプルリクエストごとに自動実行されることで、mainブランチにマージする前にバグや品質問題を発見できる。

**Why this priority**: これはCI/CDの基盤機能であり、壊れたコードがmainブランチに到達するのを防ぐ。これがなければ、他のすべてのCI/CD機能は意味をなさない。

**Independent Test**: 意図的にテスト失敗、リントエラー、型エラーを含むプルリクエストを作成し、CIパイプラインがこれらの問題を検出・報告し、マージをブロックすることを検証することで、完全にテスト可能。

**Acceptance Scenarios**:

1. **Given** 開発者がプルリクエストを作成した、**When** PRが開かれる、**Then** CIが自動的にすべてのテスト、リント、型チェック、ビルド検証を実行する
2. **Given** PRにテスト失敗がある、**When** CIが完了する、**Then** PRに失敗ステータスが表示され、マージできない
3. **Given** PRのすべてのチェックが通過している、**When** CIが完了する、**Then** PRに成功ステータスが表示され、マージできる
4. **Given** 開発者が開いているPRに新しいコミットをプッシュした、**When** プッシュが完了する、**Then** CIが自動的にすべてのチェックを再実行する
5. **Given** CIが実行中である、**When** PRステータスを確認する、**Then** 開発者はどの具体的なチェック（テスト/リント/ビルド）が実行中または失敗したかを確認できる

---

### User Story 2 - テストカバレッジ監視 (Priority: P2)

チームリーダーとして、すべてのプルリクエストでテストカバレッジメトリクスが自動生成・報告されることで、チームが最低限のカバレッジ基準を維持し、テストされていないコードを特定できる。

**Why this priority**: カバレッジ監視は長期的なコード品質を保証するが、短期的にはプロジェクトは機能する。長期的な保守性にとって重要。

**Independent Test**: カバレッジ閾値を設定し、閾値を下回るPRを作成し、CIが明確なカバレッジレポートとともに失敗することを検証することで、完全にテスト可能。

**Acceptance Scenarios**:

1. **Given** PRが作成された、**When** テストが実行される、**Then** カバレッジメトリクスが自動的に計算・報告される
2. **Given** カバレッジが定義された閾値（branches/functions/lines/statementsそれぞれ80%）を下回る、**When** CIが完了する、**Then** ビルドが失敗し、どのカバレッジメトリクスが失敗したかを示す明確なエラーメッセージが表示される
3. **Given** カバレッジが閾値を満たすか超える、**When** CIが完了する、**Then** ビルドが成功し、カバレッジサマリーが表示される
4. **Given** カバレッジレポートが生成された、**When** CI結果を表示する、**Then** 開発者はどのファイルや関数がテストカバレッジを欠いているかを特定できる

---

### User Story 3 - マルチ環境互換性検証 (Priority: P3)

開発者として、CIパイプラインが複数のNode.jsバージョンに対してコードをテストすることで、異なるランタイム環境間での互換性を保証できる。

**Why this priority**: 本番環境の信頼性には重要だが、基本的なCIが動作した後に追加できる。ほとんどの開発は単一のNode.jsバージョンで行われる。

**Independent Test**: 複数のNode.jsバージョンでマトリックスビルドを設定し、Node.jsバージョン固有のコードを導入し、CIが互換性問題を検出することを検証することで、完全にテスト可能。

**Acceptance Scenarios**:

1. **Given** プロジェクトがNode.js 20.xと22.xをサポートしている、**When** CIが実行される、**Then** すべてのチェックが両バージョンで並列実行される
2. **Given** コードが1つのNode.jsバージョンでは失敗し、別のバージョンでは成功する、**When** CIが完了する、**Then** ビルド全体が失敗し、どのバージョンで失敗したかが明確に示される
3. **Given** すべてのNode.jsバージョンで成功する、**When** CIが完了する、**Then** ビルドが成功する

---

### User Story 4 - ドキュメントと可視性 (Priority: P3)

プロジェクトメンテナーとして、プロジェクトドキュメントにCIステータスバッジとガイドラインを表示することで、貢献者が品質基準と現在のビルドステータスを理解できる。

**Why this priority**: ドキュメントは重要だが、コード品質に直接影響しない。CIパイプラインが機能した後に追加できる。

**Independent Test**: README.mdに現在のステータスを示すCIバッジが表示され、CLAUDE.mdにCIパイプラインの使い方に関する明確なガイドラインが含まれていることを検証することで、完全にテスト可能。

**Acceptance Scenarios**:

1. **Given** CIが設定された、**When** README.mdを表示する、**Then** 現在のビルドステータス（成功/失敗）を示すCIステータスバッジが表示される
2. **Given** 開発者がプロジェクトに初めて参加した、**When** CLAUDE.mdを読む、**Then** CIの仕組みと強制されるチェック内容に関する明確なガイドラインを見つけられる
3. **Given** テスト数が変更された、**When** ドキュメントを更新する、**Then** README.mdに現在のテスト数（現在187、199ではない）が反映される

---

### Edge Cases

- CIワークフローファイルが誤った設定や構文エラーを含む場合はどうなるか？
  - GitHub ActionsのActionsタブにワークフローエラーが表示され、ワークフローの実行が防止される
  - PRステータスチェックが無期限に保留中またはエラー状態として表示される
  - 開発者はワークフロー設定の問題を特定して修正できる必要がある

- システムは時々成功したり失敗したりする不安定なテストをどう扱うか？
  - CIはテスト結果をそのまま（成功または失敗）報告する
  - 不安定なテストは別途特定して修正すべき - これはテスト品質の問題であり、CIの問題ではない
  - 不安定さが広範囲になった場合、将来のイテレーションでテスト再試行メカニズムの追加を検討

- CIが予想より長くかかる場合（ネットワーク問題、パッケージインストールの遅延）はどうなるか？
  - GitHub Actionsにはデフォルトのタイムアウトがある（無料枠では6時間）
  - タイムアウトに達するとジョブが失敗する
  - 開発者は失敗したジョブを手動で再実行できる

- システムは依存関係のインストール失敗（npm installの失敗）をどう扱うか？
  - CIはインストールステップで失敗する
  - どの依存関係のインストールに失敗したかを示す明確なエラーメッセージが表示される
  - 依存関係の問題が解決されるまでPRを進められない

- 新しいNode.jsバージョンがリリースされた場合はどうなるか？
  - CIはワークフローが更新されるまで現在設定されているバージョンを使い続ける
  - チームはワークフローファイルのNode.jsバージョンマトリックスを更新して新しいバージョンを含められる
  - これは自動ではなく手動の更新プロセス

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムはmainブランチとdevelopブランチへのすべてのプルリクエストで自動的にCIワークフローをトリガーしなければならない
- **FR-002**: システムはmainブランチとdevelopブランチへのプッシュで自動的にCIワークフローをトリガーしなければならない
- **FR-003**: CIワークフローは`tsc --noEmit`を使用してTypeScript型チェックを実行しなければならない
- **FR-004**: CIワークフローは`npm run lint`を使用してESLintチェックを実行しなければならない
- **FR-005**: CIワークフローは`npm test`を使用してすべてのJestテストを実行しなければならない
- **FR-006**: CIワークフローは`npm run build`を使用してNext.jsビルド検証を実行しなければならない
- **FR-007**: CIワークフローはNode.jsバージョン20.xに対してテストしなければならない
- **FR-008**: CIワークフローはNode.jsバージョン22.xに対してテストしなければならない
- **FR-009**: CIワークフローはパフォーマンス向上のためにnpm依存関係をキャッシュしなければならない
- **FR-010**: システムはすべてのCI実行でテストカバレッジレポートを生成しなければならない
- **FR-011**: システムはbranches、functions、lines、statementsそれぞれに対して80%の最小カバレッジ閾値を強制しなければならない
- **FR-012**: システムはカバレッジが定義された閾値を下回った場合、ビルドを失敗させなければならない
- **FR-013**: カバレッジレポートはどのファイルとコードパスがテストカバレッジを欠いているかを特定しなければならない
- **FR-014**: CIステータスはマージ前にプルリクエスト上で表示されなければならない
- **FR-015**: CI失敗はプルリクエストのマージを防止しなければならない
- **FR-016**: CI結果はどのチェック（テスト、リント、型チェック、ビルド、カバレッジ）が失敗したかを明確に示さなければならない
- **FR-017**: README.mdは現在のmainブランチのビルドステータスを示すCIステータスバッジを表示しなければならない
- **FR-018**: README.mdは正確なテスト数（187テスト、199ではない）を反映しなければならない
- **FR-019**: CLAUDE.mdはCIパイプラインの使い方に関するガイドラインを含まなければならない
- **FR-020**: CIワークフローは通常の条件下で10分以内に完了しなければならない

### Key Entities *(include if feature involves data)*

- **CIワークフロー**: GitHub Actions上で実行される自動化パイプラインを表し、複数のジョブ（型チェック、リント、テスト、ビルド、カバレッジ）を含む
- **カバレッジレポート**: branches、functions、lines、statementsの割合カバレッジを含むテストカバレッジメトリクス、およびファイルレベルの詳細なカバレッジ情報を表す
- **ビルドステータス**: 特定のコミットまたはプルリクエストに対するCIパイプラインの現在の状態（保留中、成功、失敗）を表す

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: すべてのプルリクエストが作成または更新から30秒以内に自動的にCIチェックをトリガーする
- **SC-002**: CIパイプラインが通常のプルリクエストに対して、すべてのチェック（型チェック、リント、テスト、ビルド、カバレッジ）を10分以内に完了する
- **SC-003**: CIチェックが失敗したプルリクエストの100%がマージを防止される
- **SC-004**: テストカバレッジがCI実行の100%で測定・報告される
- **SC-005**: コードカバレッジがすべてのカバレッジメトリクス（branches、functions、lines、statements）で80%以上に維持される
- **SC-006**: 開発者が失敗したCI実行を表示してから10秒以内に、具体的な失敗したチェックを特定できる
- **SC-007**: CIパイプラインが2つのNode.jsバージョン（20.xと22.x）に対してコードを正常に検証する
- **SC-008**: プロジェクトドキュメントがCI実装から1日以内にCI設定と現在のテスト数を正確に反映する
- **SC-009**: README.mdのCIステータスバッジがビルド完了から5分以内に自動的に更新される
- **SC-010**: CIチェックでの誤検知がゼロである（すべての失敗は実際のコード品質問題を表す）

## Assumptions

- プロジェクトはGitHub上でホストされており、GitHub Actions（無料枠以上）にアクセスできる
- 既存のテストスイート（187テスト）は安定しており、ローカルで通過する
- プロジェクトはテスト、リント、ビルドに標準のnpmスクリプトを使用している
- 現在のコードベースで80%のカバレッジ閾値が達成可能である
- Node.js 20.xと22.xがこのプロジェクトに適切なバージョンである
- 開発者はGitとプルリクエストワークフローの基本的な知識を持っている
- mainブランチは保護されており、マージ前にステータスチェックの通過を要求する

## Out of Scope

- 本番環境またはステージング環境への継続的デプロイ（CD）
- 外部コード品質サービス（SonarQube、CodeClimateなど）との統合
- 自動依存関係更新（Dependabot、Renovate）
- CIでのパフォーマンステストまたは負荷テスト
- ビジュアルリグレッションテスト
- セキュリティスキャン（SAST、依存関係脆弱性スキャン）
- 自動変更履歴生成
- CIステータスのSlack/Discord通知
- カスタムCIランナーまたはセルフホストランナー
- マルチリポジトリまたはモノレポのCIオーケストレーション

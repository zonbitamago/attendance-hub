# Feature Specification: Test Coverage Expansion

**Feature Branch**: `008-test-coverage-expansion`
**Created**: 2025-11-11
**Status**: Draft
**Input**: 不足している重要テストの追加によるカバレッジ向上

## User Scenarios & Testing *(mandatory)*

### User Story 1 - ユーティリティ関数の完全テストカバレッジ (Priority: P1)

開発者が日付フォーマットやエラーハンドリングのユーティリティ関数を変更する際、既存の機能が破壊されていないことを自動的に検証できる。

**Why this priority**: これらのユーティリティ関数（date-utils.ts、error-utils.ts）は全ページで使用されており、現在のカバレッジは11.11%と8.88%と極端に低い。バグの影響範囲が非常に広く、日付表示やエラー処理の不具合はユーザー体験に直結する。

**Independent Test**: date-utils.tsとerror-utils.tsの全関数に対するユニットテストを実行し、90%以上のカバレッジを達成することで、これらのユーティリティが独立して正しく動作することを検証できる。

**Acceptance Scenarios**:

1. **Given** 開発者がdate-utils.tsのformatRelativeTime関数を修正する **When** テストを実行する **Then** 全てのエッジケース（過去、未来、境界値）が自動的に検証され、リグレッションがあれば即座に検出される
2. **Given** 開発者がerror-utils.tsのエラーハンドリングロジックを変更する **When** テストを実行する **Then** AppError、ZodError、通常のErrorの各ケースが正しく処理されることが検証される
3. **Given** 無効な日付やnull値が入力される **When** ユーティリティ関数を呼び出す **Then** エラーを投げずに「日付不明」などの適切なフォールバック値を返すことが検証される

---

### User Story 2 - 出欠登録ページの統合テスト (Priority: P1)

開発者が出欠登録フォームのロジックを変更する際、ユーザーが正しく出欠を登録できること、バリデーションが機能すること、エラーケースが適切に処理されることを自動的に検証できる。

**Why this priority**: 出欠登録ページ（app/[org]/events/[id]/register/page.tsx）は272行のコードを持ち、現在カバレッジは0%。これはユーザーがデータを作成する最も重要なページであり、バグがデータ破損に直結する。フォーム送信、メンバー作成、バリデーションなど複雑なロジックが含まれる。

**Independent Test**: 出欠登録ページのコンポーネントテストを実行し、フォーム操作からデータ作成までの全フローが正常に動作することを検証できる。モックを使用してサービス層から独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** ユーザーがグループとメンバーを選択し出欠ステータスを選ぶ **When** 登録ボタンをクリックする **Then** 正しいパラメータでcreateAttendanceが呼ばれ、イベント詳細ページにリダイレクトされることが検証される
2. **Given** ユーザーが既存メンバーではなく新規名前を入力する **When** 登録ボタンをクリックする **Then** createMemberが先に実行され、その後createAttendanceが呼ばれることが検証される
3. **Given** ユーザーがグループを選択せずに送信する **When** 登録ボタンをクリックする **Then** エラーメッセージが表示され、データが送信されないことが検証される
4. **Given** createAttendanceがエラーを返す **When** フォーム送信が実行される **Then** 適切なエラーメッセージが表示され、ローディング状態が解除されることが検証される

---

### User Story 3 - イベント詳細ページの統合テスト (Priority: P1)

開発者がイベント詳細表示、出欠集計、フィルター・ソート機能を変更する際、既存の機能が破壊されていないことを自動的に検証できる。

**Why this priority**: イベント詳細ページ（app/[org]/events/[id]/page.tsx）は184行のコードを持ち、現在カバレッジは0%。これはユーザーが最も頻繁に閲覧する画面であり、出欠状況の集計、グループアコーディオン、フィルター、ソート、検索など多くの機能を持つ。Feature 007で実装された新機能の保護も必要。

**Independent Test**: イベント詳細ページのコンポーネントテストを実行し、データ表示、集計計算、フィルター適用などが正常に動作することを検証できる。

**Acceptance Scenarios**:

1. **Given** イベントに複数の出欠登録が存在する **When** ページをレンダリングする **Then** 全体集計（◯/△/✗/計）とグループ別集計が正しく表示されることが検証される
2. **Given** ユーザーがフィルターで「参加」を選択する **When** AttendanceFiltersコンポーネントが状態を変更する **Then** フィルターステートが更新され、適切なプロパティがMemberAttendanceListに渡されることが検証される
3. **Given** イベントが存在しない **When** ページをレンダリングする **Then** 組織トップページにリダイレクトされることが検証される
4. **Given** 出欠登録が0件 **When** ページをレンダリングする **Then** 「まだ出欠登録がありません」というメッセージが表示されることが検証される

---

### User Story 4 - 管理画面のテスト追加 (Priority: P2)

開発者が管理画面（グループ管理、イベント管理、一括出欠登録）のCRUD操作を変更する際、既存の機能が破壊されていないことを自動的に検証できる。

**Why this priority**: 管理画面の3ページ（groups/page.tsx、events/page.tsx、my-register/page.tsx）は合計685行のコードを持ち、全て0%カバレッジ。これらはデータ管理の基盤であり、削除時のカスケード処理や一括登録などの重要なロジックを含む。ただし、ユーザーの頻繁な操作対象ではないためP2とする。

**Independent Test**: 各管理画面のコンポーネントテストを実行し、作成・編集・削除・一括操作が正常に動作することを検証できる。

**Acceptance Scenarios**:

1. **Given** グループ管理画面でグループ名とカラーを入力する **When** 作成ボタンをクリックする **Then** createGroupが正しいパラメータで呼ばれ、フォームがクリアされることが検証される
2. **Given** イベント管理画面で編集ボタンをクリックする **When** フォームに既存データが入力される **Then** タイトルが「イベント日付を編集」に変わり、更新ボタンが表示されることが検証される
3. **Given** 一括出欠登録画面でメンバーと複数イベントを選択する **When** 登録ボタンをクリックする **Then** upsertBulkAttendancesが正しい引数で呼ばれ、成功メッセージが表示されることが検証される
4. **Given** 削除ボタンをクリックする **When** 確認ダイアログが表示される **Then** キャンセルした場合は削除されず、確認した場合のみdeleteが呼ばれることが検証される

---

### Edge Cases

- 無効な日付文字列や null/undefined がユーティリティ関数に渡された場合、エラーを投げずに適切なフォールバック値を返すか？
- フォーム送信中にユーザーが再度ボタンをクリックした場合、二重送信が防止されるか？
- 存在しないイベントIDでページにアクセスした場合、適切にリダイレクトされるか？
- データが0件の場合、空状態メッセージが表示されるか？
- グループやメンバーが存在しない場合、適切なガイダンスが表示されるか？
- 非同期処理の失敗時、エラーメッセージが表示され、ローディング状態が解除されるか？
- モック関数が期待通りのパラメータで呼ばれるか？
- useMemoでメモ化された値が適切に再計算されるか？

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: テストスイートは、date-utils.tsの全6関数（formatDate、formatShortDate、formatLongDate、formatTime、getCurrentTimestamp、formatRelativeTime）の動作を検証しなければならない
- **FR-002**: テストスイートは、error-utils.tsの全エラーハンドリング関数（AppError、formatZodError、getErrorMessage、tryCatch、successMessage）の動作を検証しなければならない
- **FR-003**: テストスイートは、出欠登録ページの全フロー（グループ選択、メンバー選択/新規作成、ステータス選択、送信、エラーハンドリング）を検証しなければならない
- **FR-004**: テストスイートは、イベント詳細ページの全機能（データ表示、集計計算、フィルター、ソート、検索、空状態、エラー処理）を検証しなければならない
- **FR-005**: テストスイートは、グループ管理ページのCRUD操作（作成、編集、削除、バリデーション）を検証しなければならない
- **FR-006**: テストスイートは、イベント管理ページのCRUD操作と出欠集計表示を検証しなければならない
- **FR-007**: テストスイートは、一括出欠登録ページの全機能（メンバー選択、イベント選択、ステータス変更、一括送信）を検証しなければならない
- **FR-008**: 各テストは、既存のテストパターン（Testing Library、jest.mock、日本語テスト名）に従わなければならない
- **FR-009**: 各テストは、TDD原則（Red-Green-Refactor）に従って記述されなければならない
- **FR-010**: テストは、既存の234テストに影響を与えず、全てがpassしなければならない
- **FR-011**: テストは、適切なモック（useRouter、useParams、useOrganization、localStorage）を使用しなければならない
- **FR-012**: テストは、エッジケース（null、undefined、無効な入力、エラーケース）をカバーしなければならない

### Key Entities

本フィーチャーはテストコードの追加であり、新しいデータエンティティは作成しない。テスト対象のエンティティ（EventDate、Group、Member、Attendance、Organization）は既存のものを使用する。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: date-utils.tsのコードカバレッジが11.11%から90%以上に向上する
- **SC-002**: error-utils.tsのコードカバレッジが8.88%から90%以上に向上する
- **SC-003**: app/[org]/events/[id]/register/page.tsxのコードカバレッジが0%から80%以上に向上する
- **SC-004**: app/[org]/events/[id]/page.tsxのコードカバレッジが0%から80%以上に向上する
- **SC-005**: app/[org]/admin/groups/page.tsxのコードカバレッジが0%から80%以上に向上する
- **SC-006**: app/[org]/admin/events/page.tsxのコードカバレッジが0%から80%以上に向上する
- **SC-007**: app/[org]/my-register/page.tsxのコードカバレッジが0%から80%以上に向上する
- **SC-008**: 全体のコードカバレッジが47.98%から70%以上に向上する
- **SC-009**: テスト総数が234から350-400に増加する（約100-150テスト追加）
- **SC-010**: 全てのテストがpassし、CI/CDが成功する（npm test、npm run lint、npm run build）
- **SC-011**: カバレッジ閾値（branches: 30%、functions: 50%、lines: 45%、statements: 45%）を全て満たす
- **SC-012**: 開発者がユーティリティ関数を変更する際、90秒以内にテストを実行して結果を得られる
- **SC-013**: 開発者がページコンポーネントを変更する際、120秒以内にテストを実行して結果を得られる

## Assumptions *(optional)*

- 既存のテストインフラ（Jest、Testing Library、@testing-library/react、@testing-library/jest-dom）がそのまま使用可能
- 既存のテストパターン（モック戦略、アサーションスタイル）が適切であり、新しいテストでも踏襲できる
- テスト実行環境（Node.js、npm）は正常に動作している
- 実装コードに破壊的な変更は不要であり、テストのみを追加する
- カバレッジ閾値は現在の設定（45%、30%、50%、45%）のまま維持される

## Out of Scope *(optional)*

- E2Eテスト（Playwright、Cypressなど）の導入
- 既存テストのリファクタリング
- カバレッジ閾値の引き上げ
- テスト実行速度の最適化（既存のテストパフォーマンスは変更しない）
- 実装コードのリファクタリング
- UIコンポーネント（LoadingSpinner、Skeleton）のテスト追加
- レイアウトコンポーネント（layout.tsx、error.tsx、not-found.tsx）のテスト追加
- 既存のテストが十分なファイル（lib/attendance-service.ts、lib/group-service.tsなど）の追加テスト

## Dependencies *(optional)*

- 既存のテストインフラとツール（Jest、Testing Library）
- 既存の実装コード（テスト対象のファイル）
- プロジェクト憲法（TDD原則、コーディング規約）
- CI/CD設定（.github/workflows/test.yml）

## Security & Compliance *(optional)*

本フィーチャーはテストコードの追加であり、セキュリティやコンプライアンスへの直接的な影響はない。ただし、テストが増えることで以下のセキュリティ向上が期待される：

- エラーハンドリングの網羅的なテストにより、セキュリティ上の例外処理が適切に動作することを検証
- バリデーションロジックのテストにより、無効な入力が適切に拒否されることを検証
- 二重送信防止のテストにより、データ整合性が保たれることを検証

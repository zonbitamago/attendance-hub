# Feature Specification: Multi-Tenant Organization Support

**Feature Branch**: `005-multi-tenant`
**Created**: 2025-11-09
**Status**: Draft
**Input**: User description: "複数の異なる団体が独立してattendance-hubを使えるようにする。各団体はURLパス（例: /abc123def/, /xyz789ghi/）で識別される。localStorage + URLパスベースでマルチテナント対応を実現。団体IDはランダムに自動発行する。トップページには説明と団体作成機能のみ表示し、団体一覧は表示しない。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 団体の作成と初期設定 (Priority: P1)

管理者は新しい団体を作成し、その団体専用の出欠管理システムを開始できる。各団体には自動的にランダムなIDが発行され、そのIDを含むURLで団体にアクセスできる。作成後、URLを保存またはブックマークする必要がある。

**Why this priority**: これがなければマルチテナント機能全体が動作しない。最初に実装すべき基盤機能。

**Independent Test**: トップページで団体を新規作成し、自動発行されたURLにアクセスして団体名が表示されることを確認する。

**Acceptance Scenarios**:

1. **Given** ユーザーがトップページ（`/`）にアクセスした、**When** 「新しい団体を作成」ボタンをクリックして団体名「吹奏楽団A」を入力して保存する、**Then** 自動的にランダムなID（例: `abc123def`）が発行され、`/abc123def/` にリダイレクトされ、ヘッダーに「吹奏楽団A」が表示される
2. **Given** 団体作成後、**When** 作成完了画面でURLが表示される、**Then** ユーザーはURLをコピーまたはブックマークできる
3. **Given** 団体ID「abc123def」が既に存在する、**When** ユーザーが `/abc123def/` に直接アクセスする、**Then** 団体のイベント一覧ページが表示される
4. **Given** 存在しない団体ID「nonexistent」を入力する、**When** `/nonexistent/` にアクセスする、**Then** 404エラーページが表示され、「団体が見つかりません」というメッセージが表示される

---

### User Story 2 - 団体別データの管理 (Priority: P1)

各団体の管理者は、自分の団体専用のグループ、メンバー、イベント、出欠記録を管理できる。他の団体のデータは一切見えず、操作もできない。

**Why this priority**: マルチテナントの核心機能。データ分離がなければ複数団体が使用できない。

**Independent Test**: 2つの異なる団体を作成し、それぞれにグループとメンバーを追加して、他の団体から見えないことを確認する。

**Acceptance Scenarios**:

1. **Given** 団体ID「abc123def」でグループ「金管」とメンバー「田中太郎」を作成した、**When** 別の団体ID「xyz789ghi」の管理画面（`/xyz789ghi/admin/groups`）にアクセスする、**Then** 「金管」も「田中太郎」も表示されず、xyz789ghi専用の空のリストが表示される
2. **Given** 団体ID「abc123def」でイベント「定期演奏会」を作成した、**When** `/abc123def/` にアクセスする、**Then** 「定期演奏会」が表示される
3. **Given** 同じ状態で、**When** `/xyz789ghi/` にアクセスする、**Then** 「定期演奏会」は表示されず、xyz789ghi専用のイベントリストが表示される

---

### User Story 3 - 団体設定の編集と削除 (Priority: P2)

団体の管理者は、団体名や説明を編集したり、団体全体を削除したりできる。削除時には全ての関連データ（グループ、メンバー、イベント、出欠記録）も削除される。

**Why this priority**: 団体の運用管理に必要だが、最初の運用開始には必須ではない。後から追加できる。

**Independent Test**: 団体を作成し、データを追加した後、団体設定で名前を変更し、最後に団体を削除して全データが消えることを確認する。

**Acceptance Scenarios**:

1. **Given** 団体が存在する、**When** `/[org-id]/admin/organizations` にアクセスして団体名を「吹奏楽団A改」に変更して保存する、**Then** ヘッダーに「吹奏楽団A改」と表示される
2. **Given** 団体にグループ、メンバー、イベントが登録されている、**When** 団体設定で「団体を削除」ボタンをクリックして確認ダイアログで「削除する」を選択する、**Then** トップページ（`/`）にリダイレクトされ、localStorage から全ての関連データが削除される
3. **Given** 団体を削除した後、**When** その団体のURLに直接アクセスする、**Then** 404エラーページが表示される

---

### User Story 4 - 既存データの自動マイグレーション (Priority: P1)

既存のユーザーが初めてマルチテナント版にアクセスした際、現在のデータを「デフォルト団体」として自動的に移行し、データを失わずに継続して使用できる。

**Why this priority**: 既存ユーザーのデータ保護は最優先事項。これがないと既存ユーザーが全データを失う。

**Independent Test**: 旧バージョンのlocalStorageデータを手動で作成し、新バージョンで初回アクセス時に自動的にマイグレーションされることを確認する。

**Acceptance Scenarios**:

1. **Given** 旧バージョンのlocalStorageに `attendance_event_dates`, `attendance_groups` などのキーでデータが保存されている、**When** マルチテナント版で初めてトップページ（`/`）にアクセスする、**Then** 「デフォルト団体」が自動的に作成され（名前: 「マイ団体」、ランダムID発行）、既存データが新しいキーに移行され、デフォルト団体のURLにリダイレクトされる
2. **Given** マイグレーション後、**When** デフォルト団体のURLにアクセスする、**Then** 既存のイベント、グループ、メンバー、出欠記録がすべて正しく表示される
3. **Given** マイグレーション済みの状態で、**When** 再度トップページにアクセスする、**Then** 二重マイグレーションは実行されず、通常のトップページ（説明 + 団体作成ボタン）が表示される

---

### User Story 5 - 団体URLの共有とブックマーク (Priority: P2)

ユーザーは団体のURLをブックマークしたり、他の人と共有したりできる。URLには自動発行されたランダムIDが含まれ、このURLを知っている人だけがアクセスできる。

**Why this priority**: マルチテナントの利便性とプライバシー保護に重要だが、基本動作には必須ではない。

**Independent Test**: 団体のURLをブックマークし、後日そのブックマークから直接アクセスできることを確認する。

**Acceptance Scenarios**:

1. **Given** 団体が作成され、URLが `/abc123def/` である、**When** ユーザーがこのURLをブックマークして後日アクセスする、**Then** 団体のページが正しく表示される
2. **Given** 同じ状態で、**When** ユーザーがURLをコピーして別のデバイス（同じブラウザプロファイル）に貼り付けてアクセスする、**Then** 同じ団体のページが表示される（localStorageが同期されている場合）
3. **Given** ユーザーが団体URLを知らない、**When** トップページ（`/`）にアクセスする、**Then** 既存の団体一覧は表示されず、新規作成のみ可能（プライバシー保護）

---

### Edge Cases

- 同時に複数の団体を作成しようとした場合でも、各団体には一意のランダムIDが発行される
- localStorageの容量制限（約5-10MB）に達した場合、エラーメッセージが表示され、古いデータの削除を促す
- ブラウザのlocalStorageが無効になっている場合、警告メッセージを表示して機能が使用できないことを通知する
- URLパラメータの団体IDが不正な形式の場合、404エラーを表示する
- 極めて稀なケースとして、ランダムIDの衝突が発生した場合、再生成して一意性を保証する
- 団体作成後、ユーザーがURLを保存し忘れた場合、その団体にアクセスする方法がなくなる（localStorageには残るが、アクセス不可）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは複数の独立した団体を管理できること。各団体は一意のランダムID、名前を持つ。
- **FR-002**: 団体作成時に、ランダムなIDが自動的に発行されること。IDは短く（8-12文字）、URL安全な文字列（英数字小文字）であること。
- **FR-003**: 各団体は一意のURLパス（`/[random-id]/`）で識別されること。
- **FR-004**: トップページ（`/`）には説明文と団体作成ボタンのみ表示され、既存の団体一覧は表示されないこと。
- **FR-005**: 団体URLを知っている人だけがその団体にアクセスできること（プライバシー保護）。
- **FR-006**: すべてのデータ（イベント、グループ、メンバー、出欠記録）は特定の団体に紐付けられ、団体IDをフィールドとして持つこと。
- **FR-007**: localStorageのキーは団体IDを含む形式（`attendance_${orgId}_${dataType}`）で保存され、団体間でデータが完全に分離されること。
- **FR-008**: 団体作成時には、団体名と説明（オプション）を入力できること。IDは自動発行されるため入力不要。
- **FR-009**: 団体作成完了時に、発行されたURLを明示的に表示し、ユーザーに保存を促すこと。
- **FR-010**: 各団体専用のページ構造は `/[org-id]/`, `/[org-id]/admin/groups`, `/[org-id]/events/[event-id]` などの形式になること。
- **FR-011**: 団体設定ページ（`/[org-id]/admin/organizations`）で団体情報の編集と削除ができること。削除時には確認ダイアログを表示する。
- **FR-012**: 団体削除時には、その団体に紐づく全てのデータ（グループ、メンバー、イベント、出欠記録）もlocalStorageから削除されること。
- **FR-013**: 既存の単一団体データを検出した場合、初回アクセス時に自動的に「デフォルト団体」（名前: 「マイ団体」）を作成してデータを移行し、そのURLにリダイレクトすること。
- **FR-014**: マイグレーション完了後は、フラグ（`attendance_migration_completed`）をlocalStorageに保存し、二重実行を防止すること。
- **FR-015**: 存在しない団体IDでアクセスした場合、404エラーページを表示すること。
- **FR-016**: すべての既存ページとコンポーネントは、現在の団体コンテキストを認識し、その団体のデータのみを操作すること。
- **FR-017**: アプリケーション内のすべてのナビゲーションとリンクは、現在の団体IDを含むパスを使用すること。
- **FR-018**: ランダムID生成時に衝突が発生した場合（極めて稀）、再生成して一意性を保証すること。

### Key Entities

- **Organization（団体）**: アプリケーションを使用する独立した団体を表す。各団体はランダムに発行された一意のIDを持ち、名前と説明を含む。全てのデータはいずれかの団体に所属する。URLを知っている人だけがアクセスできる。
  - 属性: id（ランダムに発行される8-12文字の文字列）、name（表示名）、description（説明、オプション）、createdAt（作成日時）

- **EventDate（イベント）**: 特定の団体に紐づく練習や本番などのイベント。
  - 既存属性に追加: organizationId（団体への参照）

- **Group（グループ）**: 特定の団体内のパートやセクション。
  - 既存属性に追加: organizationId（団体への参照）

- **Member（メンバー）**: 特定の団体内のグループに所属するメンバー。
  - 既存属性に追加: organizationId（団体への参照）

- **Attendance（出欠記録）**: 特定の団体内のメンバーとイベントの組み合わせによる出欠状況。
  - 既存属性に追加: organizationId（団体への参照）

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 複数の異なる団体（最低3団体）が同時に利用でき、各団体のデータが完全に分離されていることを確認できる
- **SC-002**: 既存ユーザーが新バージョンに更新した際、データを失わずに「デフォルト団体」として継続利用できる（マイグレーション成功率100%）
- **SC-003**: ユーザーは団体の新規作成から専用ページへのアクセスまで、2ステップ以内（約20秒以内）で完了できる（IDは自動発行されるため入力不要）
- **SC-004**: 異なる団体間でデータ混在が発生しないことを、自動テストで100%検証できる
- **SC-005**: 自動発行されたURLを使って団体に直接アクセスでき、ブックマークが可能である
- **SC-006**: トップページには団体一覧が表示されず、URLを知らない限りアクセスできないことを確認できる（プライバシー保護）

## Assumptions

- ユーザーはlocalStorageが有効なブラウザを使用している
- 同一ブラウザ内で複数団体を切り替えて使用することを想定（認証機能はなし）
- 1つのブラウザにつき、最大10-20団体程度の運用を想定（localStorage容量制限内）
- 将来的にはSupabase（PostgreSQL + 認証）への移行を予定しているため、データモデルはその前提で設計する
- ランダムIDは8-12文字の英数字小文字で構成され、URL安全であること
- ランダムID生成にはnanoidまたは同様のライブラリを使用することを想定
- IDの衝突確率は実用上無視できるほど低い（10^9回生成で1%程度の衝突確率）
- ユーザーは団体作成時に発行されたURLを自分で保存・管理する責任がある
- URLを失った場合、その団体にアクセスする手段はない（セキュリティとプライバシーのトレードオフ）

## Constraints

- localStorageの容量制限（約5-10MB）により、大量のデータや多数の団体を保存できない
- ブラウザ間やデバイス間でのデータ同期はできない（localStorageの制約）
- 認証機能がないため、URLを知っている人は誰でもアクセスできる
- 同一ブラウザを複数人で共有する場合、プライバシーの問題がある
- Next.js App Routerの動的ルーティング（`[org]`）を使用するため、既存のルート構造を大幅に変更する必要がある
- ランダムIDは読みにくいため、ユーザーが手動でURLを入力することは困難
- URLを失うと団体にアクセスできなくなる（復旧手段なし）
- localStorageに保存されたデータは永続的だが、ブラウザのデータ削除で失われる可能性がある

## Out of Scope

以下は本フィーチャーの範囲外とし、将来の拡張または別フィーチャーとして扱う：

- ユーザー認証とログイン機能
- 団体へのメンバー招待機能
- 失われたURLの復旧機能
- 団体一覧の表示機能（プライバシー保護のため意図的に除外）
- 団体間でのデータ共有や移行機能
- 団体のロゴやカスタムテーマ設定
- 団体の権限管理（管理者、メンバーなどのロール）
- データベース（Supabase）への移行（別フィーチャーとして扱う）
- サブドメインベースの団体識別（パスベースのみ実装）
- 団体のアーカイブや一時停止機能
- 人間が読みやすいカスタムスラッグ機能（ランダムIDのみ）
- 団体URLの短縮機能
- localStorageのバックアップ・エクスポート機能

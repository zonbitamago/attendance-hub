# タスク: イベント人数表示機能

**入力**: `/specs/003-event-attendance-count/` からの設計ドキュメント
**前提条件**: plan.md, spec.md, data-model.md, research.md

**テスト**: プロジェクト憲法によりt-wadaのTDD原則に厳密に従う

**TDD原則（t-wada）**:

1. **小さなステップ**: 一度に一つのテストケースに集中
2. **Red-Green-Refactor**: 各テストごとに失敗（Red）→通過（Green）→改善（Refactor）
3. **テストファースト**: 実装コードより先にテストを書く
4. **テストの独立性**: 各テストは他のテストに依存しない

**構成**: タスクはユーザーストーリーごとにグループ化され、各ストーリー内で1テストずつRed-Green-Refactorサイクルを実行

## フォーマット: `[ID] [P?] [Story] 説明`

- **[P]**: 並列実行可能（異なるファイル、依存関係なし）
- **[Story]**: このタスクが属するユーザーストーリー（例: US1, US2, US3）
- 説明には正確なファイルパスを含める

## パス規約

- リポジトリルートのNext.js App Router構造
- `app/` ページとレイアウト
- `lib/` ビジネスロジック
- `types/` TypeScript型定義
- `__tests__/` テストファイル

---

## フェーズ1: セットアップ（共通インフラ）

**目的**: プロジェクト構造と依存関係の確認

- [X] T001 TypeScript 5.9+とNext.js 16+がインストールされていることを確認
- [X] T002 Jest 29+とReact Testing Library 14+が設定されていることを確認
- [X] T003 types/index.ts内の既存のEventDateとAttendance型をレビュー

**チェックポイント**: 環境が実装準備完了

---

## フェーズ2: 基盤（ブロッキング前提条件）

**目的**: すべてのユーザーストーリーが依存するコア型定義とサービス関数

**⚠️ 重要**: このフェーズが完了するまで、ユーザーストーリーの作業を開始できません

### 基盤の実装（TDD: 1テストずつRed-Green-Refactor）

#### テストケース1: 基本シナリオの集計

- [X] T004 **[Red]** テストを書く: calculateEventTotalSummaryが基本シナリオで正しい合計を返す（**tests**/lib/attendance-service.test.ts）
- [X] T005 **[Green]** EventTotalSummary型をtypes/index.tsで定義
- [X] T006 **[Green]** calculateEventTotalSummary関数の骨組みをlib/attendance-service.tsで実装（基本シナリオのみ対応）
- [X] T007 **[Green]** テストを実行し、T004のテストが通ることを確認
- [X] T008 **[Refactor]** 必要に応じてコードを整理（テストは通ったまま）

#### テストケース2: 出欠登録なしの場合

- [X] T009 **[Red]** テストを書く: calculateEventTotalSummaryが出欠登録なしの場合すべて0を返す（**tests**/lib/attendance-service.test.ts）
- [X] T010 **[Green]** calculateEventTotalSummary関数を拡張してT009のテストを通す
- [X] T011 **[Green]** テストを実行し、T004とT009の両方が通ることを確認
- [X] T012 **[Refactor]** 必要に応じてコードを整理（テストは通ったまま）

#### テストケース3: メンバー重複カウント防止

- [X] T013 **[Red]** テストを書く: calculateEventTotalSummaryがメンバー重複カウントを防ぐ（**tests**/lib/attendance-service.test.ts）
- [X] T014 **[Green]** Set<string>を使った重複排除ロジックを追加してT013のテストを通す
- [X] T015 **[Green]** テストを実行し、T004、T009、T013のすべてが通ることを確認
- [X] T016 **[Refactor]** 重複排除ロジックを整理（テストは通ったまま）

#### テストケース4: 無効なeventDateId

- [X] T017 **[Red]** テストを書く: calculateEventTotalSummaryが無効なeventDateIdを適切に処理（**tests**/lib/attendance-service.test.ts）
- [X] T018 **[Green]** エラーハンドリングを追加してT017のテストを通す
- [X] T019 **[Green]** テストを実行し、すべての基盤テスト（T004、T009、T013、T017）が通ることを確認
- [X] T020 **[Refactor]** 全体のコードを見直して最終調整

#### 基盤の完成

- [X] T021 calculateEventTotalSummaryをlib/attendance-service.tsからエクスポート
- [X] T022 すべてのテストを再実行し、44+新規テストがすべて通ることを確認

**チェックポイント**: 基盤準備完了 - すべてのテストが通過、ユーザーストーリー実装を並列開始可能

---

## フェーズ3: ユーザーストーリー1 - イベント一覧で参加状況を一目で把握（優先度: P1）🎯 MVP

**目標**: イベント一覧ページの各イベントカードに出欠人数（◯ X人 △ Y人 ✗ Z人（計W人））を表示

**独立テスト**: <http://localhost:3000> を開き、各イベントカードに「◯ X人 △ Y人 ✗ Z人（計W人）」形式で表示されることを確認

### ユーザーストーリー1の実装（TDD: 1テストずつRed-Green-Refactor）

#### テストケース1: 基本的な出欠人数レンダリング

- [X] T023 **[Red]** [US1] コンポーネントテストを書く: イベント一覧が各イベントの出欠人数をレンダリング（**tests**/app/page.test.tsx）
- [X] T024 **[Green]** [US1] app/page.tsxにcalculateEventTotalSummaryをインポート
- [X] T025 **[Green]** [US1] app/page.tsxで各イベントのcalculateEventTotalSummary呼び出しをメモ化するuseMemoフックを追加
- [X] T026 **[Green]** [US1] app/page.tsxのイベントカードに「◯ X人 △ Y人 ✗ Z人（計W人）」形式の出欠人数表示UIを追加（最小限のスタイル）
- [X] T027 **[Green]** [US1] テストを実行し、T023のテストが通ることを確認
- [X] T028 **[Refactor]** [US1] 必要に応じてコンポーネント構造を整理

#### テストケース2: 出欠登録なしの場合の表示

- [X] T029 **[Red]** [US1] コンポーネントテストを書く: イベント一覧が出欠登録なしの場合「◯ 0人 △ 0人 ✗ 0人（計0人）」を表示（**tests**/app/page.test.tsx）
- [X] T030 **[Green]** [US1] ゼロ人数の表示ロジックを確認・調整してT029のテストを通す
- [X] T031 **[Green]** [US1] テストを実行し、T023とT029の両方が通ることを確認
- [X] T032 **[Refactor]** [US1] 表示ロジックを整理

#### テストケース3: 複数イベントでの正しい人数表示

- [X] T033 **[Red]** [US1] コンポーネントテストを書く: イベント一覧が複数イベント存在時に正しい人数を表示（**tests**/app/page.test.tsx）
- [X] T034 **[Green]** [US1] 複数イベントのループ処理を確認・調整してT033のテストを通す
- [X] T035 **[Green]** [US1] テストを実行し、すべてのUS1テスト（T023、T029、T033）が通ることを確認
- [X] T036 **[Refactor]** [US1] ループ処理とメモ化を最適化

#### UI改善とアクセシビリティ

- [X] T037 **[Refactor]** [US1] app/page.tsxでモバイルファーストのレスポンシブデザイン用にTailwind CSSスタイリングを適用
- [X] T038 **[Refactor]** [US1] app/page.tsxでアクセシビリティのためセマンティックHTMLとARIAラベルを追加
- [X] T039 **[Green]** [US1] すべてのテストを再実行し、US1のすべてのテストが通ることを確認
- [X] T040 **[Manual]** [US1] 手動テスト: <http://localhost:3000> を開き、出欠人数が正しく表示されることを確認

**チェックポイント**: ユーザーストーリー1完了、独立してテスト可能 - MVPデモ準備完了

---

## フェーズ4: ユーザーストーリー2 - イベント詳細で全体集計を確認（優先度: P2）

**目標**: イベント詳細ページのグループ別集計の上にイベント全体の出欠集計を表示

**独立テスト**: <http://localhost:3000/events/[id]> を開き、グループ集計の上に「参加: X人 / 未定: Y人 / 欠席: Z人（計W人）」が表示されることを確認

### ユーザーストーリー2の実装（TDD: 1テストずつRed-Green-Refactor）

#### テストケース1: イベント全体集計の基本表示

- [X] T041 **[Red]** [US2] コンポーネントテストを書く: イベント詳細がグループ集計の上にイベント全体集計をレンダリング（**tests**/app/events/[id]/page.test.tsx）
- [X] T042 **[Green]** [US2] app/events/[id]/page.tsxにcalculateEventTotalSummaryをインポート
- [X] T043 **[Green]** [US2] app/events/[id]/page.tsxでcalculateEventTotalSummary呼び出しをメモ化するuseMemoフックを追加
- [X] T044 **[Green]** [US2] app/events/[id]/page.tsxの既存グループ集計の上にイベント全体集計セクションを追加（最小限のスタイル）
- [X] T045 **[Green]** [US2] 「参加: X人 / 未定: Y人 / 欠席: Z人（計W人）」形式で集計を表示
- [X] T046 **[Green]** [US2] テストを実行し、T041のテストが通ることを確認
- [X] T047 **[Refactor]** [US2] 集計セクションの構造を整理

#### テストケース2: 出欠登録なしの場合

- [X] T048 **[Red]** [US2] コンポーネントテストを書く: イベント詳細が出欠登録なしの場合0を表示（**tests**/app/events/[id]/page.test.tsx）
- [X] T049 **[Green]** [US2] ゼロ人数の表示を確認・調整してT048のテストを通す
- [X] T050 **[Green]** [US2] テストを実行し、T041とT048の両方が通ることを確認
- [X] T051 **[Refactor]** [US2] 条件分岐を整理

#### テストケース3: 全体集計とグループ集計の整合性

- [X] T052 **[Red]** [US2] コンポーネントテストを書く: イベント全体合計がグループ集計の合計と一致（**tests**/app/events/[id]/page.test.tsx）
- [X] T053 **[Green]** [US2] 整合性を確認（既存ロジックで通るはず）、必要に応じて調整
- [X] T054 **[Green]** [US2] テストを実行し、すべてのUS2テスト（T041、T048、T052）が通ることを確認
- [X] T055 **[Refactor]** [US2] 全体のコードを見直し

#### UI改善

- [X] T056 **[Refactor]** [US2] app/events/[id]/page.tsxで一貫したデザインのためTailwind CSSスタイリングを適用
- [X] T057 **[Refactor]** [US2] app/events/[id]/page.tsxで集計セクション用のセマンティックHTML構造を追加
- [X] T058 **[Green]** [US2] すべてのテストを再実行し、US2のすべてのテストが通ることを確認
- [X] T059 **[Manual]** [US2] 手動テスト: イベント詳細ページを開き、イベント全体集計が正しく表示されることを確認

**チェックポイント**: ユーザーストーリー1と2の両方が独立して動作

---

## フェーズ5: ユーザーストーリー3 - 管理画面で詳細な人数内訳を確認（優先度: P3）

**目標**: イベント管理ページの各イベント行に出欠人数（◯ X人 △ Y人 ✗ Z人（計W人））を表示

**独立テスト**: <http://localhost:3000/admin/events> を開き、各イベント行に「◯ X人 △ Y人 ✗ Z人（計W人）」形式で表示されることを確認

### ユーザーストーリー3の実装（TDD: 1テストずつRed-Green-Refactor）

#### テストケース1: 基本的な出欠人数レンダリング

- [X] T060 **[Red]** [US3] コンポーネントテストを書く: イベント管理ページが各イベントの出欠人数をレンダリング（**tests**/app/admin/events/page.test.tsx）
- [X] T061 **[Green]** [US3] app/admin/events/page.tsxにcalculateEventTotalSummaryをインポート
- [X] T062 **[Green]** [US3] app/admin/events/page.tsxで各イベントのcalculateEventTotalSummary呼び出しをメモ化するuseMemoフックを追加
- [X] T063 **[Green]** [US3] app/admin/events/page.tsxの各イベント行に出欠人数表示を追加
- [X] T064 **[Green]** [US3] 「◯ X人 △ Y人 ✗ Z人（計W人）」形式で人数を表示（最小限のスタイル）
- [X] T065 **[Green]** [US3] テストを実行し、T060のテストが通ることを確認
- [X] T066 **[Refactor]** [US3] 表示ロジックを整理

#### テストケース2: 出欠登録なしの場合

- [X] T067 **[Red]** [US3] コンポーネントテストを書く: 管理ページが出欠登録なしの場合0を表示（**tests**/app/admin/events/page.test.tsx）
- [X] T068 **[Green]** [US3] ゼロ人数の表示を確認・調整してT067のテストを通す
- [X] T069 **[Green]** [US3] テストを実行し、T060とT067の両方が通ることを確認
- [X] T070 **[Refactor]** [US3] 条件分岐を整理

#### テストケース3: イベント削除時の更新

- [X] T071 **[Red]** [US3] コンポーネントテストを書く: 管理ページがイベント削除時に人数を更新（**tests**/app/admin/events/page.test.tsx）
- [X] T072 **[Green]** [US3] 削除後の再レンダリングを確認（既存ロジックで通るはず）、必要に応じて調整
- [X] T073 **[Green]** [US3] テストを実行し、すべてのUS3テスト（T060、T067、T071）が通ることを確認
- [X] T074 **[Refactor]** [US3] 削除処理周りを見直し

#### UI改善

- [X] T075 **[Refactor]** [US3] app/admin/events/page.tsxで管理テーブルレイアウト用にTailwind CSSスタイリングを適用
- [X] T076 **[Refactor]** [US3] app/admin/events/page.tsxでモバイル管理画面用のレスポンシブデザインを確保
- [X] T077 **[Green]** [US3] すべてのテストを再実行し、US3のすべてのテストが通ることを確認
- [X] T078 **[Manual]** [US3] 手動テスト: イベント管理ページを開き、出欠人数が正しく表示されることを確認

**チェックポイント**: すべてのユーザーストーリー（1、2、3）が独立して機能している

---

## フェーズ6: 仕上げと横断的関心事

**目的**: 複数のユーザーストーリーに影響する改善と最終検証

### コード品質チェック

- [X] T079 フルテストスイートを実行し、すべてのテストが通ることを確認（新規テスト含む）
- [X] T080 `npx tsc --noEmit`でTypeScript型チェックを実行し、エラーを修正
- [X] T081 ESLintを実行し、リンティング問題を修正
- [X] T082 コードクリーンアップ: 未使用のインポートやコメントアウトされたコードを削除

### コードレビュー（憲法準拠チェック）

- [X] T083 **[Code Review]** 型安全性の確認: `any`型の不正使用がないか確認
- [X] T084 **[Code Review]** TDDサイクルの確認: すべての新規コードがテストファーストで実装されたか確認
- [X] T085 **[Code Review]** セキュリティパターンの確認: 入力検証、XSS対策が適切か確認
- [X] T086 **[Code Review]** パフォーマンスの確認: useMemoが適切に使用されているか確認
- [X] T087 **[Code Review]** アクセシビリティの確認: セマンティックHTML、ARIAラベルが適切か確認
- [X] T088 **[Code Review]** 日本語UIの確認: すべてのUIテキストが日本語で正確か確認
- [X] T089 **[Code Review]** レスポンシブデザインの確認: モバイルファーストで実装されているか確認

### 機能テスト

- [X] T090 パフォーマンステスト: 100件以上のイベントが2秒以内に読み込まれることを確認（SC-005）
- [X] T091 アクセシビリティテスト: キーボードナビゲーションとスクリーンリーダー互換性を確認
- [X] T092 モバイルテスト: 320px、768px、1024pxのビューポートでレイアウトを確認
- [X] T093 クロスブラウザテスト: Chrome、Firefox、Safariで確認
- [X] T094 エッジケーステスト: メンバー重複カウント防止が正しく動作することを確認

### ドキュメント更新

- [X] T095 必要に応じてCLAUDE.mdを最新の変更で更新
- [X] T096 quickstart.md検証: quickstart.mdの手順に従ってセットアップを確認

### コードレビュー指摘事項の対応

- [X] T097 **[Fix]** コードレビューで指摘された問題を修正（該当する場合）
- [X] T098 **[Green]** 修正後、すべてのテストを再実行して通ることを確認
- [X] T099 **[Manual]** 修正後、手動テストで機能が正しく動作することを確認

---

## 依存関係と実行順序

### フェーズの依存関係

- **セットアップ（フェーズ1）**: 依存関係なし - すぐに開始可能
- **基盤（フェーズ2）**: セットアップ完了に依存 - すべてのユーザーストーリーをブロック
- **ユーザーストーリー（フェーズ3-5）**: すべて基盤フェーズ完了に依存
  - その後、ユーザーストーリーを並列実行可能（スタッフがいる場合）
  - または優先度順に順次実行（P1 → P2 → P3）
- **仕上げ（フェーズ6）**: すべての必要なユーザーストーリーが完了していることに依存

### ユーザーストーリーの依存関係

- **ユーザーストーリー1（P1）**: 基盤（フェーズ2）後に開始可能 - 他のストーリーに依存しない ✅ 独立
- **ユーザーストーリー2（P2）**: 基盤（フェーズ2）後に開始可能 - 他のストーリーに依存しない ✅ 独立
- **ユーザーストーリー3（P3）**: 基盤（フェーズ2）後に開始可能 - 他のストーリーに依存しない ✅ 独立

### TDDサイクル（t-wada原則）

各テストケースごとに以下を厳守:

1. **Red**: テストを1つ書く - 失敗を確認
2. **Green**: そのテストを通す最小限の実装
3. **Refactor**: テストを通したままコードを改善
4. **次のテストへ**: 1つずつ進める（複数同時に書かない）

### タスク実行の原則

- **小さなステップ**: 一度に1つのテストケースのみに集中
- **テストの独立性**: 各テストは他のテストに依存しない
- **品質維持**: テストコードもプロダクションコードと同等の品質

---

## 実装戦略

### MVPファースト（ユーザーストーリー1のみ）

1. フェーズ1完了: セットアップ（T001-T003）
2. フェーズ2完了: 基盤（T004-T022）
   - 1テストずつRed-Green-Refactorサイクル
3. フェーズ3完了: ユーザーストーリー1（T023-T040）
   - 1テストずつRed-Green-Refactorサイクル
4. **停止して検証**: ユーザーストーリー1を独立してテスト
5. 準備できていればデプロイ/デモ

### 段階的デリバリー

1. セットアップ + 基盤を完了 → 基盤準備完了（T001-T022）
2. ユーザーストーリー1を追加 → 独立してテスト → デプロイ/デモ（MVP!）（T023-T040）
3. ユーザーストーリー2を追加 → 独立してテスト → デプロイ/デモ（T041-T059）
4. ユーザーストーリー3を追加 → 独立してテスト → デプロイ/デモ（T060-T078）
5. 仕上げと検証（T079-T099）
   - コード品質チェック（T079-T082）
   - コードレビュー（T083-T089）
   - 機能テスト（T090-T094）
   - ドキュメント更新（T095-T096）
   - レビュー対応（T097-T099）
6. 各ストーリーが既存のストーリーを壊さずに価値を追加

---

## 注記

- **t-wadaのTDD原則に厳密に従う**: 一度に1つのテストケースのみ、Red-Green-Refactorサイクル厳守
- **小さなステップ**: 複数のテストを同時に書かない
- **テストの独立性**: 各テストは他のテストに依存しない
- [P]タスク = 異なるファイル、依存関係なし、並列実行可能（ただし各ストーリー内ではTDDサイクルを順守）
- [Story]ラベル = タスクを特定のユーザーストーリーにマッピングしてトレーサビリティを確保
- 各タスクまたは論理的なグループ後にコミット
- 任意のチェックポイントで停止してストーリーを独立して検証
- タスク総数: 99
  - セットアップ: 3
  - 基盤: 19（TDDサイクル × 4テストケース）
  - ユーザーストーリー1: 18（TDDサイクル × 3テストケース + UI改善）
  - ユーザーストーリー2: 19（TDDサイクル × 3テストケース + UI改善）
  - ユーザーストーリー3: 19（TDDサイクル × 3テストケース + UI改善）
  - 仕上げ: 21（品質チェック4 + コードレビュー7 + 機能テスト5 + ドキュメント2 + レビュー対応3）

---

## タスク実行チェックリスト

タスクを完了としてマークする前に確認:

- [X] TypeScriptがエラーなくコンパイルされる（`npx tsc --noEmit`）
- [X] 該当する場合、テストが通る（`npm test`）
- [X] コードがプロジェクトスタイルガイドに従っている（`npm run lint`）
- [X] 変更が明確なメッセージでコミットされている
- [X] UIタスクの手動テストが完了

## 成功基準マッピング

- **SC-001**（1秒以内に確認）: T040、T082でテスト
- **SC-002**（即座に把握）: T059でテスト
- **SC-003**（詳細な人数内訳）: T078でテスト
- **SC-004**（正確な集計）: T004-T019、T022でテスト
- **SC-005**（2秒以内、100件以上）: T082でテスト
- **SC-006**（90%満足度）: すべてのストーリー完了後に手動検証
